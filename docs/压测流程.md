# 环境部署

## nodejs
将node.zip压缩包上传至服务器，解压后可得node和node-v10.7.0两个文件夹，分别对应node可执行文件和nodejs源码

使用./node/bin/node [filename] [argument]启动程序

## caliper-for-trustsql
将caliper-for-trustsql-lastest.zip压缩包上传至服务器，解压后可得caliper-for-trustsql-lastest文件夹，包含测试程序和数据生成程序


## run.sh
chmod +x run.sh
   
# 峰值测量 

## 生成数据

1. 测峰值时可以预先生成一个小时的数据量
2. 进入到caliper-for-trustsql-lastest目录下，执行./run.sh data后台开始生成数据
3. 日志保存在caliper-for-trustsql-lastest/logs/generator.log中
4. 生成的数据保存在caliper-for-trustsql-lastest/src/generator/sqls/目录下


## 修改trustsql-server-peak.json
1. 四个节点的配置信息
2. asset字段下的ip列表

## 配置文件:
1. config-trustsql-peak.json
2. trustsql-server-peak.json

## 启动:
进入caliper-for-trustsql路径下，执行./run.sh peak开始测量峰值

# 稳定性测量

## 修改trustsql-server-stability.json文件
1. 四个节点的配置信息
2. asset和transfer字段下的ip列表
   
## 配置文件:
1. config-trustsql-stability.json
2. trustsql-server-stability.json

## 启动
进入caliper-for-trustsql路径下，执行./run.sh stability开始测量稳定性 


 ## 配置文件解析
 config-generator.json

 ```json
{
    "process_count": 20,
    "issue": {
        "enable": true,
        "number": 100
    },
    "transfer": {
        "enable": true,
        "number": 10,
        "start_privkey_index": 1
    },
    "file": {
        "sql_path": "sqls",
        "utxo_path": "utxos",
        "file_size": 200000,
        "file_start_id": 0
    },
    "monitor": {
        "enable": true,
        "file_system_id": 6,
        "limit": 80,
        "sleep_time": 600000
    },
    "callback": "generator.js"
}
 ```

 process_count字段用来控制进程数，需要根据测试情况选择(可以调成CPU核数)

 issue字段用来控制资产发行数据的生成

 1. enable表示是否需要生成资产发行，第一次启动为true，后续如果想增加交易数量而不增加资产数量就设置为false
 2. number每个账户发行的资产数量(资产发行的总数最好控制在1000W)

transfer字段控制转账数据的生成

1. enable表示是否生成转账数据，默认为true，无特殊情况不需要修改
2. number表示每个私钥的转账次数
3. start_privkey_index(忽略，程序自动计算)

file字段控制数据的存储

1. sql_path表示生成的sql数据的相对路径
2. utxo_path表示每个账户的utxo的相对存储路径
3. file_size表示每个文件可以保存的sql数量(测试时是一次性读取整个文件，太大会增加io时间，太小会增加io次数，需要适当调节，默认20W)
4. file_start_id表示生成的sql数据保存的文件名起始id(忽略，自动计算)

monitor字段控制磁盘容量，防止生成速率过快导致硬盘空间不足(只在linux系统下有效)
1. enable表示是否启动，默认为true
2. file_system_id表示监控哪个文件系统，通过df -h命令查看获取id(从0开始)
3. limit表示最大使用百分比，当容量超过这个限制时程序会进入睡眠
4. sleep_time表示睡眠时间，单位是秒

callback字段控制执行程序


> 生成数据的程序如果非正常停止，也可以继续运行


## 日志
命令行会持续打印当前提交数，成功数，失败数以及未完成数，同时增加了每秒tps和程序启动到当前时间点tps的统计信息

日志共两个文件，位于caliper-for-trustsql-lastest/logs/目录下，分别是state.log和error.log

1. state.log保存每秒和启动到当前时间点的tps信息
2. error.log保存失败交易的原因


# 注意事项

1. 压测峰值时为了保证充分利用CPU，需要预先生成一个小时的所有测试数据
2. 生成数据可以分多次运行./run.sh data，第一次需要发行资产，后续仅生成转账的测试数据(唯一需要改动的是将配置文件issue字段下的enable设置为false)


